/* Render a virtual page view in Joplin's previewer
 *
 * jvirtpage.css is a stylesheet that will enable any note within the Joplin
 * application to render as an aesthetically pleasing virtual page in the
 * Joplin markdown viewer (the previewer).
 * 
 * Install the "Import Local CSS" plugin. Then @import this stylesheet within
 * your note. Alternatively, configure "Import Local CSS" to enable this
 * stylesheet by default for all of your notes.
 *
 * For more detail, refer to the documentation:
 * https://github.com/taw00/joplin-tweaks/docs/jvirtpage.md
 *
 * Joplin is Copyright (c) Laurent Cozic
 * This work is …
 * Copyright (c) Todd Warner <t0dd [at] protonmail [dot] com>  
 * This work is licensed under Attribution 4.0 International. To view a copy
 * of this license, visit http://creativecommons.org/licenses/by/4.0/
 */

@layer jvirtpage {
    :root {
        /* default behavior of a linked-to PDF in a note - currently enabled
         * also controlled by classes no-pdfs and show-pdfs */
        --jvp-pdf-display: none;  /* want, by default, not displayed? (remains a link) */
        --jvp-pdf-display: block; /* want, by default, displayed (embedded) */

        /* default behavior of the margin markers - currently displayed
         * also controlled by classes no-markers and show-markers */
        --jvp-margin-markers-display: none;  /* want them off */
        --jvp-margin-markers-display: block; /* want them on */

        /* CONSTANTS */
        --jvp-text-color: black;
        --jvp-paper-color: white;
        --jvp-desktop-color: hsl(0deg 0% 66%); /* darkgray */
        --jvp-paper-box-shadow: 0 0 var(--jvp-page-spacing) black;
        --jvp-1st-page-marker-color: hsl(from var(--jvp-text-color) h s l / 10%);

        --jvp-dim-text-color: black;
        --jvp-dim-paper-color: hsl(0deg 0% 75%); /* silver */
        --jvp-dim-desktop-color: hsl(0deg 0% 41%); /* dimgray */

        --jvp-dark-text-color: hsl(0deg 0% 96%); /* whitesmoke; not white */
        --jvp-dark-paper-color: hsl(0deg 0% 12%); /* very dark gray */
        --jvp-dark-desktop-color: hsl(0deg 0% 20%); /* darker than dimgray */
        /*--jvp-dark-desktop-color: hsl(222deg 12% 16%);*/ /* a dark purple-blue */

        /* popular page dimensions */
        --jvp-page-widthUS:  8.5in;  --jvp-page-heightUS:   11in;  --jvp-page-marginUS:   1in;
        --jvp-page-widthUSh: 5.5in;  --jvp-page-heightUSh: 8.5in;  --jvp-page-marginUSh: .5in;
        --jvp-page-widthA4:  210mm;  --jvp-page-heightA4:  297mm;  --jvp-page-marginA4:   1in;
        --jvp-page-widthA5:  148mm;  --jvp-page-heightA5:  210mm;  --jvp-page-marginA5:  .5in;
        --jvp-page-widthA6:  105mm;  --jvp-page-heightA6:  148mm;  --jvp-page-marginA6: .25in;

        /* default for each is 1/2 the default margin widths */
        --jvp-indentUS:   calc(var(--jvp-page-marginUS) * .5);
        --jvp-indentUSh: calc(var(--jvp-page-marginUSh) * .5);
        --jvp-indentA4:   calc(var(--jvp-page-marginA4) * .5);
        --jvp-indentA5:   calc(var(--jvp-page-marginA5) * .5);
        --jvp-indentA6:   calc(var(--jvp-page-marginA6) * .5);

        /* the defaults for page dimensions and margin and indent */
        --jvp-page-width:  var(--jvp-page-widthUS);
        --jvp-page-height: var(--jvp-page-heightUS);
        --jvp-page-margin: var(--jvp-page-marginUS);
        --jvp-indent:      var(--jvp-page-indentUS);

        /* Joplin Cloud stuff */
        --jvp-jcloud-footer-color: hsl(from var(--jvp-paper-color) h s l / 50%);
        --jvp-jcloud-footer-color-link: hsl(from var(--jvp-jcloud-footer-color) h s l / 90%);

        /* SWITCHES
         * Switches to change the default page dimensions, margins, indent and
         * theme.  Enabled by sticking this div somewhere in your document, for
         * example:
         *      <div id="jvp" class="A5 landscape dark"></div>               */
        &:has( div#jvp:where(.dark) ) {
            --jvp-text-color:    var(--jvp-dark-text-color);
            --jvp-paper-color:   var(--jvp-dark-paper-color);
            --jvp-desktop-color: var(--jvp-dark-desktop-color);
            --jvp-1st-page-marker-color: hsl(from var(--jvp-text-color) h s l / 8%);
            --jvp-jcloud-footer-color: hsl(from black h s l / 35%);
            --jvp-jcloud-footer-color-link: hsl(from var(--jvp-jcloud-footer-color) h s l / 50%);
        }
        &:has( div#jvp:where(.dim) ) {
            --jvp-text-color:    var(--jvp-dim-text-color);
            --jvp-paper-color:   var(--jvp-dim-paper-color);
            --jvp-desktop-color: var(--jvp-dim-desktop-color);
            --jvp-1st-page-marker-color: hsl(from var(--jvp-text-color) h s l / 10%);
        }

        &:has( div#jvp:where(.US,.us) ) {
            /* the defaults for everything - already set; being pedantic */
            --jvp-page-width:  var(--jvp-page-widthUS);
            --jvp-page-height: var(--jvp-page-heightUS);
            --jvp-page-margin: var(--jvp-page-marginUS);
            --jvp-indent:      var(--jvp-page-indentUS);
        }
        &:has( div#jvp:where(.US,.us).landscape ) {
            --jvp-page-width:  var(--jvp-page-heightUS);
            --jvp-page-height: var(--jvp-page-widthUS);
        }
        &:has( div#jvp:where(.USh,.USH,.ush) ) {
            --jvp-page-width:  var(--jvp-page-widthUSh);
            --jvp-page-height: var(--jvp-page-heightUSh);
            --jvp-page-margin: var(--jvp-page-marginUSh);
            --jvp-indent:      var(--jvp-page-indentUSh);
        }
        &:has( div#jvp:where(.USh,.USH,.ush).landscape ) {
            --jvp-page-width: var(--jvp-page-heightUSh);
            --jvp-page-height: var(--jvp-page-widthUSh);
        }
        &:has( div#jvp:where(.A4,.a4) ) {
            --jvp-page-width:  var(--jvp-page-widthA4);
            --jvp-page-height: var(--jvp-page-heightA4);
            --jvp-page-margin: var(--jvp-page-marginA4);
            --jvp-indent:      var(--jvp-page-indentA4);
        }
        &:has( div#jvp:where(.A4,.a4).landscape ) {
            --jvp-page-width:  var(--jvp-page-heightA4);
            --jvp-page-height: var(--jvp-page-widthA4);
        }
        &:has( div#jvp:where(.A5,.a5) ) {
            --jvp-page-width:  var(--jvp-page-widthA5);
            --jvp-page-height: var(--jvp-page-heightA5);
            --jvp-page-margin: var(--jvp-page-marginA5);
            --jvp-indent:      var(--jvp-page-indentA5);
        }
        &:has( div#jvp:where(.A5,.a5).landscape ) {
            --jvp-page-width:  var(--jvp-page-heightA5);
            --jvp-page-height: var(--jvp-page-widthA5);
        }
        &:has( div#jvp:where(.A6,.a6) ) {
            --jvp-page-width:  var(--jvp-page-widthA6);
            --jvp-page-height: var(--jvp-page-heightA6);
            --jvp-page-margin: var(--jvp-page-marginA6);
            --jvp-indent:      var(--jvp-page-indentA6);
        }
        &:has( div#jvp:where(.A6,.a6).landscape ) {
            --jvp-page-width:  var(--jvp-page-heightA6);
            --jvp-page-height: var(--jvp-page-widthA6);
        }
        &:has( div#jvp:where(.no-page-markers,.no-markers) ) {
            --jvp-margin-markers-display: none;
        }
        &:has( div#jvp:where(.show-page-markers,.show-markers) ) {
            --jvp-margin-markers-display: block;
        }
        &:has( div#jvp:where(.nopdfs,.no-pdfs, .nopdf,.no-pdf) ) {
            --jvp-pdf-display: none;
        }
        &:has( div#jvp:where(.showpdfs,.show-pdfs, .showpdf,.show-pdf) ) {
            --jvp-pdf-display: block;
        }

        /* OTHER CONSTANTS - don't change these */
        --jvp-page-spacing: 20px;
        --jvp-min-margin: 13vw; /* 13% of the viewport width. */

    } /* end :root */
} /* end @layer jvirtpage */


/* Uncomment this :has and its mirroring brace at the end of the file if you
 * want to require <div id="jvp"></div> to exist in a note before allowing any
 * of this formatting to function. I.e., the stylings will be OFF by default if
 * you uncomment this and its ending brace.
:has( div:where(#jvp) ) {
*/

/* If on by default (i.e., you haven't uncommented the above), turn off these
 * stylings with <div id="jvp" class="off"></div> somewhere within your note.
 * (Note that the div#vpage rule makes this compatible with the manuscript-css
 * project.) */
:not( :has( :where(#jvp:where(.off), #jvp-off, #jvpoff, div#vpage > article#manuscript) ) ) {


/*
 * configuration for both @media screen and print
 */
#rendered-md .media-player.media-pdf {
    /* do we display PDFs? */
    display: var(--jvp-pdf-display);
}

/* no-links, no-links-export
 * If you want to disable links in your document: one option disables all
 * links (no-links), and another only disables links in an exported PDF
 * (no-links-export)
 * Note, no-links-export rules defined in @media print section */
:has(:where(#jvp:where(#no-links,#disable-links,.no-links,.disable-links))) {
    a,
    a:is(:any-link,:link,:active,:visited,:hover) {
        pointer-events: none;
        cursor: default;
        color: inherit;
        text-decoration: unset;
        border: unset;
    }
}

/* Joplin Cloud stuff
 * - Remove the viewport cruft (title, last-updated, padding, etc.) */
body.page-note {
    & > main.main > div.container.main-container {
        & > div.note-main {
            /* viewport to 100% */
            margin: 0 auto;
            padding: 0;
            max-width: 100%;
            /* remove note title */
            /* remove "Last updated" line */
            & > h1.title,
            & > p.last-updated { display: none; }
        }
    }
}


/*
 * configuration for screen and HTML rendering
 */
@media screen {
    html { background-color: var(--jvp-desktop-color); }
    body {
        /* a virtual paper look: <body> is the "desk" behind the paper */
        background-color: var(--jvp-desktop-color);
        padding: 0;
    }

    body#joplin-container-body {
        /* Remove the padding and bg that frames #rendered-md */
        & > #joplin-container-content {
            background-color: transparent;
            padding: 0;
        }
    }
    /* exported to HTML */
    body:not(#joplin-container-body) {
        & > div.exported-note {
            margin: 0;
            padding: 0;
            & > div.exported-note-title {
                display: none !important;
            }
        }
    }

    /* Joplin Cloud stuff
     * - Fade the navbar and footer. Still present, just not prominent. */
    body.page-note {
        /* footer with copyright and T&Cs - fade to watermark */
        & > div.footer div.content {
            opacity: initial;
            color: var(--jvp-jcloud-footer-color);
            & a {
                color: var(--jvp-jcloud-footer-color-link);
            }
        }
        & > main.main > div.container.main-container {
            /* branded navbar - fade to watermark and remove fluff*/
            & > nav.navbar {
                opacity: 0.2;
                background-color: inherit;
                box-shadow: unset;
                border: unset;
            }
        }
    }

    #rendered-md {
        position: relative;
        box-shadow: var(--jvp-paper-box-shadow);
        box-sizing: border-box;
        margin-block: var(--jvp-page-spacing); /* just sets the page off the top a bit */
        margin-inline: auto;
        padding-block: min(var(--jvp-page-margin),var(--jvp-min-margin));
        padding-inline: min(var(--jvp-page-margin),var(--jvp-min-margin));
        color: var(--jvp-text-color);
        background-color: var(--jvp-paper-color);

        /* show bit of margin surrounding the virtual page on small screens */
        width: 96%;
        max-width: var(--jvp-page-width);

        min-height: var(--jvp-page-height);

        /* This is either ugly or clever. Maybe simply "too clever" …
         * We are attempting to remove the top margin from the first element.
         * But that element block may be one of <style></style> or
         * <div id="jvp"></div>. And so we keep working down the line.
         * Note, for :last-child, we are less concerned if the end spacing is
         * absolutely cleared out. */
        & > :first-child {
            margin-block-start: 0;
            padding-block-start: 0;
            &:where(#jvp) + * {
                margin-block-start: 0;
                padding-block-start: 0;
            }
            &:where(style) {
                & + * {
                    margin-block-start: 0;
                    padding-block-start: 0;
                }
                & + :where(#jvp) + * {
                    margin-block-start: 0;
                    padding-block-start: 0;
                }
            }
        }
        & > :last-child {
            margin-block-end: 0;
            padding-block-end: 0;
        }

        /* add a left-side 1st-page margin marker to the rendering */
        & div#jvp::before {
            display: var(--jvp-margin-markers-display);
            position: absolute;
            content: "";
            --tmp-content-height: calc(var(--jvp-page-height) - var(--jvp-page-margin) - var(--jvp-page-margin));
            top: var(--jvp-page-margin);
            left: 0;
            width: calc(var(--jvp-page-margin) / 4);
            height: calc(var(--tmp-content-height));
            border-block: var(--jvp-1st-page-marker-color) solid 2px;
            border-inline-start: unset;
            border-inline-end: var(--jvp-1st-page-marker-color) solid 1px;
            margin-inline-start: calc(var(--jvp-page-margin) * .75);
            margin-inline-end: unset;
        }
        /* add a right-side 1st-page margin marker to the rendering */
        & div#jvp::after {
            display: var(--jvp-margin-markers-display);
            position: absolute;
            content: "";
            --tmp-content-height: calc(var(--jvp-page-height) - var(--jvp-page-margin) - var(--jvp-page-margin));
            top: var(--jvp-page-margin);
            right: 0;
            width: calc(var(--jvp-page-margin) / 4);
            height: calc(var(--tmp-content-height));
            border-block: var(--jvp-1st-page-marker-color) solid 2px;
            border-inline-start: var(--jvp-1st-page-marker-color) solid 1px;
            border-inline-end: unset;
            margin-inline-start: unset;
            margin-inline-end: calc(var(--jvp-page-margin) * .75);
        }
        & div#jvp:is(.help,.switches) {
            &::before {
                display: block;
                position: relative;
                content: "Switches (all classes):\A"
                  "\9 off\A\9\9 Turn off jvirtpage styles.\A"
                  "\9 dark, dim\A\9\9 Set an alternative theme.\A"
                  "\9 us (default), ush, a4, a5, a6\A\9\9 Set @page dimensions.\A"
                  "\9 no-page-markers, show-page-markers (default)\A\9\9 No/Show fancy margin indicators.\A"
                  "\9 no-pdfs, show-pdfs (default)\A\9\9 No/Show expansion of PDFs within note preview.\A"
                  "\9 no-links, no-links-export\A\9\9 Turn off all links. Turn off all links upon export.\A"
                  "\9 help\A\9\9 Display this help text.";
                top: 0;
                left: 0;
                width: calc(var(--jvp-page-width) - var(--jvp-page-margin) - var(--jvp-page-margin));
                height: auto;
                white-space: pre-wrap;
                border: 2px solid var(--jvp-1st-page-marker-color);
                padding: 10px;
                margin-block-end: 10px;
                margin-inline: unset;
            }
            &::after {
                display: none;
            }
        }
    } /* end #rendered-md */

} /* end @media screen */


/*
 * configuration for print and PDF rendering
 */
@media print {
    html,
    body {
        page: jvp-page-dimensions;
        width: 100%; max-width: 100%; border: 0; padding: 0; margin: 0; background-color: transparent;
    }
    #rendered-md {
        width: 100%; max-width: 100%; padding: 0; margin: 0; box-shadow: unset;
    }

    /* remove Joplin-inserted title & padding */
    body > div.exported-note {
        margin: 0;
        padding: 0;
        & > div.exported-note-title {
            display: none;
        }
    }

    /* Joplin Cloud stuff
     * - We don't want anything but our document to be printed. */
    body.page-note {
        /* remove footer with copyright and T&Cs */
        & > div.footer { display: none; }
        & > main.main > div.container.main-container {
            /* remove branded navbar */
            & > nav.navbar { display: none; }
        }
    }

    div#joplin-container-pluginAssetsContainer { display: none !important; }

    /* no-links, no-links-export
     * If you want to disable links in your document: one option disables all
     * links (no-links), and another only disables links in an exported PDF
     * (no-links-export)
     * Note, no-links rules defined outside of @media print section above */
    :has(:where(#jvp:where(
      #no-links-pdf,#disable-links-pdf,.no-links-pdf,.disable-links-pdf,
      #no-links-export,#disable-links-export,.no-links-export,.disable-links-export))) {
        a,
        a:is(:any-link,:link,:active,:visited,:hover) {
            pointer-events: none;
            cursor: default;
            color: inherit;
            text-decoration: unset;
            border: unset;
        }
    }
} /* end @media print */

} /* end :not( :has( :where(#jvp:where(.off)) ) ) */

/* Uncomment the brace below and its mirroring :has( div:where(#jvp) ) { toward
 * the top of the file if you want to require <div id="jvp"></div> to exist in
 * a note before allowing any of this formatting to function.
}
*/


@page jvp-page-dimensions {
    /* IMPORTANT NOTE: Joplin 3.4.12 and older disallow exporting to PDF with a
     * different page size than what you have set in the joplin settings. That
     * limitation is a bug that should be fixed in the next major release.
     * https://github.com/laurent22/joplin/issues/13096
     *
     * The workaround is to export to HTML, open that in a browser, then print
     * to file (PDF). In a few months, as of this writing (20250916), this will
     * no longer be an issue.
     */
    size: var(--jvp-page-width) var(--jvp-page-height);
    margin: var(--jvp-page-margin);
}

